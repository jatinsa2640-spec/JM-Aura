    <!-- Detail View -->
    <transition name="fade" mode="out-in" v-cloak>
        <div v-if="currentTab === 'detail'" class="min-h-screen">
            <div v-if="selectedAlbum">
                <!-- Hero Header -->
                <div class="relative w-full rounded-[32px] overflow-hidden shadow-2xl mb-8 bg-surface-variant group">
                    <!-- Background Image -->
                    <div class="absolute inset-0 opacity-60 dark:opacity-40">
                        <img v-if="selectedAlbum.image" :src="getImageUrl(selectedAlbum.image)" class="w-full h-full object-cover blur-2xl scale-110">
                    </div>
                    <!-- Gradient Overlay -->
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent"></div>
                    
                    <!-- Content Container -->
                    <div class="relative z-10 p-5 md:p-10 pt-20 md:pt-32 flex flex-col md:flex-row gap-6 md:gap-8 items-start md:items-end">
                        <!-- Back Button -->
                        <div class="absolute top-6 left-6 z-20">
                            <button @click="currentTab = 'search'" class="flex items-center gap-2 text-white/90 hover:text-white bg-black/30 backdrop-blur-md px-4 py-2 rounded-full transition hover:bg-black/40">
                                <span class="material-symbols-rounded">arrow_back</span> 
                                <span class="font-medium">Back</span>
                            </button>
                        </div>

                        <!-- Poster Image -->
                        <div class="shrink-0 relative group-hover:scale-[1.02] transition-transform duration-500 ease-out">
                            <img v-if="selectedAlbum.image" :src="getImageUrl(selectedAlbum.image)" 
                                class="w-32 h-48 sm:w-40 sm:h-60 md:w-52 md:h-80 object-cover rounded-2xl shadow-2xl border-4 border-white/10">
                        </div>
                        
                        <!-- Info Text -->
                        <div class="flex-1 text-white pb-2 min-w-0 w-full">
                            <div class="flex flex-wrap gap-2 mb-4">
                                <span class="px-3 py-1 bg-primary text-on-primary rounded-full text-xs font-bold tracking-wider uppercase shadow-lg shadow-primary/20">Manga</span>
                                <span class="px-3 py-1 bg-white/20 backdrop-blur-md text-white rounded-full text-xs font-bold border border-white/10">ID: {{ selectedAlbum.album_id }}</span>
                            </div>
                            
                            <h1 class="text-2xl sm:text-3xl md:text-5xl font-bold leading-tight mb-6 text-shadow-lg break-words line-clamp-3" :title="selectedAlbum.title">
                                {{ selectedAlbum.title }}
                            </h1>
                            
                            <div class="flex flex-wrap items-center gap-6 text-white/90 text-sm md:text-base font-medium">
                                <span class="flex items-center gap-2 bg-black/20 px-3 py-1.5 rounded-lg backdrop-blur-sm">
                                    <span class="material-symbols-rounded text-primary-container">person</span> 
                                    {{ selectedAlbum.author }}
                                </span>
                                <span class="flex items-center gap-2 bg-black/20 px-3 py-1.5 rounded-lg backdrop-blur-sm">
                                    <span class="material-symbols-rounded text-primary-container">photo_library</span> 
                                    {{ selectedAlbum.image_count }} Pages
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-8 mt-8">
                    <!-- Main Info -->
                    <div class="flex-1 space-y-8">
                        <!-- Actions -->
                        <div class="flex flex-col gap-3">
                            <div class="flex gap-4">
                                <button @click="startReading(selectedAlbum)" 
                                    class="md-btn-primary flex-1 shadow-lg shadow-primary/30 py-4 h-auto text-lg">
                                    <span class="material-symbols-rounded mr-2">menu_book</span> 
                                    {{ getReadingButtonText(selectedAlbum.album_id) }}
                                </button>

                                <button @click="toggleSelectionMode"
                                    class="w-14 h-14 rounded-2xl bg-surface-variant border border-outline/10 text-on-surface-variant flex items-center justify-center hover:bg-primary hover:text-on-primary transition shadow-sm"
                                    :title="isSelectionMode ? '取消选话下载' : '选话下载'">
                                    <span class="material-symbols-rounded">{{ isSelectionMode ? 'close' : 'checklist' }}</span>
                                </button>
                            </div>
                            
                            <!-- History Hint -->
                            <div v-if="getHistoryText(selectedAlbum.album_id)" class="text-xs text-primary font-medium px-1 flex items-center gap-1 animate-pulse">
                                <span class="material-symbols-rounded text-sm">history</span>
                                {{ getHistoryText(selectedAlbum.album_id) }}
                            </div>
                        </div>
                        
                        <div class="flex gap-4 items-center">
                            <button @click="toggleFavorite(selectedAlbum)" 
                                class="flex-1 h-10 rounded-full border border-outline/30 flex items-center justify-center gap-2 text-sm font-medium text-on-surface hover:bg-surface-variant transition"
                                :class="{'text-primary border-primary bg-primary/5': isFavorite(selectedAlbum.album_id)}">
                                <span class="material-symbols-rounded text-lg" :class="{'font-variation-settings-fill': isFavorite(selectedAlbum.album_id)}">favorite</span>
                                {{ isFavorite(selectedAlbum.album_id) ? 'Favorited' : 'Add to Favorites' }}
                            </button>
                        </div>

                        <!-- Description -->
                        <div class="md-card p-6 md:p-8">
                            <h3 class="text-xl font-bold mb-4 flex items-center gap-3">
                                <span class="material-symbols-rounded text-primary">description</span> Description
                            </h3>
                            <p class="leading-relaxed whitespace-pre-wrap opacity-80">{{ selectedAlbum.description || 'No description provided.' }}</p>
                        </div>

                        <!-- Episodes -->
                        <div>
                            <div class="flex items-center justify-between gap-3 mb-4 px-2">
                                <h3 class="text-xl font-bold flex items-center gap-3">
                                    <span class="material-symbols-rounded text-primary">list</span>
                                    Chapters <span class="text-sm font-normal opacity-60 bg-surface-variant px-2 py-0.5 rounded-full">{{ selectedAlbum.episode_list ? selectedAlbum.episode_list.length : 0 }}</span>
                                </h3>
                                <div v-if="selectedAlbum.episode_list && isSelectionMode" class="flex items-center gap-2">
                                    <button v-if="selectedAlbum.episode_list.length > 1" @click="selectAll" class="h-10 px-4 rounded-full bg-surface-variant border border-outline/10 text-on-surface-variant hover:bg-surface transition text-sm font-medium">
                                        <span class="material-symbols-rounded mr-2">select_all</span>
                                        全选
                                    </button>
                                    <button @click="downloadSelected" :disabled="selectedChapters.length === 0"
                                        class="md-btn-primary h-10 px-4 disabled:opacity-40 disabled:cursor-not-allowed">
                                        <span class="material-symbols-rounded mr-2">download</span>
                                        下载 {{ selectedChapters.length }}
                                    </button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                <div v-for="ep in selectedAlbum.episode_list" :key="ep.id" 
                                     class="md-card border border-transparent hover:border-primary/20 p-4 cursor-pointer hover:shadow-md transition group flex items-center gap-3"
                                     @click="handleChapterClick(ep)">
                                    <div class="w-10 h-10 rounded-full bg-surface-variant text-primary flex items-center justify-center font-bold text-sm group-hover:bg-primary group-hover:text-on-primary transition-colors">
                                        {{ ep.title.match(/\d+/) ? ep.title.match(/\d+/)[0] : '#' }}
                                    </div>
                                    <div class="flex-1 truncate text-sm font-medium opacity-80 group-hover:opacity-100">{{ ep.title }}</div>
                                    <span v-if="isSelectionMode" class="w-9 h-9 rounded-full border border-outline/10 flex items-center justify-center"
                                        :class="isSelected(ep.id) ? 'bg-primary text-on-primary border-transparent' : 'bg-surface text-on-surface-variant'">
                                        <span class="material-symbols-rounded text-lg">{{ isSelected(ep.id) ? 'check' : 'add' }}</span>
                                    </span>
                                    <span v-else class="material-symbols-rounded text-outline group-hover:text-primary">play_arrow</span>
                                </div>
                            </div>
                        </div>

                        <div class="md-card p-6 md:p-8">
                            <div class="flex items-center justify-between gap-3 mb-4">
                                <h3 class="text-xl font-bold flex items-center gap-3">
                                    <span class="material-symbols-rounded text-primary">recommend</span>
                                    也在看
                                </h3>
                                <button @click="loadAlsoViewed(selectedAlbum.album_id)" :disabled="alsoViewedLoading"
                                    class="w-10 h-10 rounded-full bg-surface-variant text-on-surface-variant flex items-center justify-center hover:bg-primary hover:text-on-primary transition disabled:opacity-40"
                                    title="Refresh">
                                    <span class="material-symbols-rounded" :class="alsoViewedLoading ? 'animate-spin' : ''">refresh</span>
                                </button>
                            </div>

                            <div v-if="alsoViewedLoading" class="flex items-center justify-center py-10 opacity-60">
                                <span class="material-symbols-rounded text-4xl animate-spin text-primary">progress_activity</span>
                            </div>

                            <div v-else-if="alsoViewedItems.length === 0" class="p-4 rounded-2xl bg-surface-variant/60 border border-outline/10 text-sm text-on-surface-variant">
                                暂无推荐
                            </div>

                            <div v-else class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                                <div v-for="book in alsoViewedItems" :key="book.album_id"
                                     class="md-card overflow-hidden cursor-pointer group flex flex-col h-full"
                                     @click="viewDetails(book.album_id)">
                                    <div class="aspect-[3/4] overflow-hidden relative bg-surface-variant">
                                         <img v-if="book.image" :src="getImageUrl(book.image)" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy" alt="Cover">
                                         <div v-else class="w-full h-full flex items-center justify-center opacity-40">
                                            <span class="material-symbols-rounded text-5xl">image</span>
                                         </div>
                                    </div>
                                    
                                    <div class="p-3 flex flex-col flex-1">
                                        <h3 class="font-medium text-sm line-clamp-2 leading-tight mb-1 group-hover:text-primary transition-colors">{{ book.title }}</h3>
                                        <div class="mt-auto pt-2 flex items-center justify-between opacity-80">
                                            <p class="text-xs truncate max-w-[70%]">{{ book.author || '' }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="md-card p-6 md:p-8" id="comments">
                            <div class="flex items-center justify-between gap-3 mb-4">
                                <h3 class="text-xl font-bold flex items-center gap-3">
                                    <span class="material-symbols-rounded text-primary">chat_bubble</span>
                                    Comments
                                    <span v-if="commentTotal" class="text-sm font-normal opacity-60 bg-surface-variant px-2 py-0.5 rounded-full">{{ commentTotal }}</span>
                                </h3>
                                <div class="flex items-center gap-2">
                                    <button @click="fetchComments(commentPage)" :disabled="commentLoading"
                                        class="w-10 h-10 rounded-full bg-surface-variant text-on-surface-variant flex items-center justify-center hover:bg-primary hover:text-on-primary transition disabled:opacity-40"
                                        title="Refresh">
                                        <span class="material-symbols-rounded">refresh</span>
                                    </button>
                                </div>
                            </div>

                            <div v-if="!isLoggedIn" class="p-4 rounded-2xl bg-surface-variant/60 border border-outline/10 text-sm text-on-surface-variant mb-6 flex items-center gap-2">
                                <span class="material-symbols-rounded text-primary">info</span>
                                Sign in to post comments.
                            </div>

                            <div class="space-y-3 mb-6">
                                <div v-if="commentReplyTo" class="flex items-center justify-between gap-2 text-xs text-on-surface-variant bg-surface-variant/60 border border-outline/10 rounded-2xl px-4 py-2">
                                    <div class="truncate">Replying to #{{ commentReplyTo }}</div>
                                    <button @click="cancelReply" class="w-8 h-8 rounded-full bg-surface-variant text-on-surface-variant hover:bg-surface transition flex items-center justify-center">
                                        <span class="material-symbols-rounded text-base">close</span>
                                    </button>
                                </div>

                                <textarea v-model="commentText" rows="3" :disabled="commentSending || !isLoggedIn"
                                    class="w-full rounded-2xl bg-surface-variant/60 border border-outline/20 px-4 py-3 text-sm outline-none focus:border-primary/60 focus:ring-2 focus:ring-primary/20 transition resize-none disabled:opacity-50"
                                    placeholder="Write a comment..."></textarea>
                                <div class="flex justify-end gap-3">
                                    <button @click="sendComment" :disabled="commentSending || !isLoggedIn || !commentText.trim() || (commentCooldownUntil && Date.now() < commentCooldownUntil)"
                                        class="md-btn-primary h-10 px-5 disabled:opacity-40 disabled:cursor-not-allowed">
                                        <span v-if="commentSending" class="material-symbols-rounded animate-spin mr-2">progress_activity</span>
                                        <span v-else class="material-symbols-rounded mr-2">send</span>
                                        <span v-if="commentCooldownUntil && Date.now() < commentCooldownUntil">等待 {{ Math.max(0, Math.ceil((commentCooldownUntil - Date.now()) / 1000)) }}s</span>
                                        <span v-else>Post</span>
                                    </button>
                                </div>
                            </div>

                            <div v-if="commentLoading" class="flex items-center justify-center py-10 opacity-60">
                                <span class="material-symbols-rounded text-4xl animate-spin text-primary">progress_activity</span>
                            </div>

                            <div v-else-if="commentItems.length === 0" class="flex flex-col items-center justify-center py-12 opacity-60">
                                <span class="material-symbols-rounded text-5xl text-outline mb-3">chat</span>
                                <p class="font-medium text-on-surface-variant">No comments</p>
                            </div>

                            <div v-else class="space-y-4">
                                <comment-node
                                    v-for="c in commentTree"
                                    :key="c.CID"
                                    :node="c"
                                    :parent="null"
                                    :depth="0"
                                    :is-logged-in="isLoggedIn"
                                    :revealed-spoilers="revealedSpoilers"
                                    :liked-comments="likedCommentIds"
                                    :like-loading="commentLikeLoading"
                                    :get-avatar-url="getUserAvatarUrl"
                                    :strip-html="stripHtml"
                                    @reply="replyToComment"
                                    @toggle-spoiler="toggleSpoiler"
                                    @like="likeComment"
                                ></comment-node>

                                <div class="flex justify-center items-center gap-6 pt-2">
                                    <button @click="fetchComments(commentPage - 1)" :disabled="commentPage <= 1 || commentLoading"
                                        class="w-12 h-12 rounded-full bg-surface-container-high text-on-surface flex items-center justify-center disabled:opacity-30 hover:bg-primary hover:text-on-primary transition">
                                        <span class="material-symbols-rounded">arrow_back</span>
                                    </button>
                                    <span class="text-sm font-medium opacity-80">Page {{ commentPage }} / {{ commentTotalPages }}</span>
                                    <button @click="fetchComments(commentPage + 1)" :disabled="commentPage >= commentTotalPages || commentLoading"
                                        class="w-12 h-12 rounded-full bg-surface-container-high text-on-surface flex items-center justify-center disabled:opacity-30 hover:bg-primary hover:text-on-primary transition">
                                        <span class="material-symbols-rounded">arrow_forward</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div v-else class="flex items-center justify-center min-h-[50vh]">
                <span class="material-symbols-rounded text-6xl animate-spin text-primary/50">settings_backup_restore</span>
            </div>
        </div>
    </transition>
