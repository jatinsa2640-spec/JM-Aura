    <transition name="fade" mode="out-in" v-cloak>
        <div v-if="currentTab === 'jm_favorites'" class="space-y-6 pb-20">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                <div class="min-w-0">
                    <h2 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                        <span class="material-symbols-rounded text-primary">favorite</span>
                        JM 收藏
                    </h2>
                    <p class="text-sm opacity-60 mt-1">文件夹管理 / 移动 / 分页</p>
                </div>
                <div class="flex flex-wrap items-center justify-end gap-2">
                    <button v-if="!jmFavSelectionMode" @click="toggleJmFavSelectionMode" class="h-10 px-4 rounded-full bg-surface-variant border border-outline/10 text-on-surface-variant hover:bg-primary hover:text-on-primary transition text-sm font-bold">
                        <span class="material-symbols-rounded text-base mr-1">select_check_box</span>
                        多选
                    </button>
                    <button v-else @click="toggleJmFavSelectionMode" class="h-10 px-4 rounded-full bg-primary text-on-primary shadow-md transition text-sm font-bold">
                        <span class="material-symbols-rounded text-base mr-1">close</span>
                        退出
                    </button>
                    <button @click="openJmFolderCreate" class="md-btn-primary !h-10 !px-4">
                        <span class="material-symbols-rounded">create_new_folder</span>
                        新建
                    </button>
                    <button @click="loadJmFavorites(1)" :disabled="jmFavLoading"
                        class="w-10 h-10 rounded-full bg-surface-variant text-on-surface-variant flex items-center justify-center hover:bg-primary hover:text-on-primary transition disabled:opacity-40">
                        <span class="material-symbols-rounded" :class="jmFavLoading ? 'animate-spin' : ''">refresh</span>
                    </button>
                </div>
            </div>

            <div v-if="!isLoggedIn" class="md-card p-4 md:p-6 border border-outline/10">
                <div class="flex items-center gap-3 text-on-surface-variant">
                    <span class="material-symbols-rounded text-primary">info</span>
                    <span>请先在 Settings 登录 JM。</span>
                </div>
            </div>

            <div v-else class="grid grid-cols-1 md:grid-cols-12 gap-6">
                <div class="md:col-span-3">
                    <div class="md-card p-4 border border-outline/10">
                        <div class="flex items-center justify-between mb-3">
                            <div class="font-bold flex items-center gap-2">
                                <span class="material-symbols-rounded text-primary">folder</span>
                                文件夹
                            </div>
                            <button @click="loadJmFavorites(1)" :disabled="jmFavLoading"
                                class="w-9 h-9 rounded-full bg-surface-variant text-on-surface-variant flex items-center justify-center hover:bg-primary hover:text-on-primary transition disabled:opacity-40">
                                <span class="material-symbols-rounded" :class="jmFavLoading ? 'animate-spin' : ''">sync</span>
                            </button>
                        </div>

                        <div class="space-y-2">
                            <div v-for="f in jmFavFolders" :key="f.id"
                                @click="selectJmFavFolder(f)"
                                role="button"
                                class="w-full flex items-center justify-between gap-2 px-4 py-3 rounded-2xl border text-sm font-medium transition cursor-pointer"
                                :class="jmFavFolderId === f.id ? 'bg-primary text-on-primary border-transparent shadow-md' : 'bg-surface text-on-surface border-outline/20 hover:bg-primary/10'">
                                <span class="truncate">{{ f.name }}</span>
                                <div v-if="f.id !== '0'" class="flex items-center gap-1">
                                    <button @click.stop="openJmFolderRename(f)"
                                        class="w-9 h-9 rounded-full bg-black/5 hover:bg-black/10 dark:bg-white/10 dark:hover:bg-white/20 flex items-center justify-center">
                                        <span class="material-symbols-rounded text-base">edit</span>
                                    </button>
                                    <button @click.stop="deleteJmFolder(f)"
                                        class="w-9 h-9 rounded-full bg-black/5 hover:bg-black/10 dark:bg-white/10 dark:hover:bg-white/20 flex items-center justify-center">
                                        <span class="material-symbols-rounded text-base">delete</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-9 space-y-4">
                    <div class="md-card p-4 border border-outline/10 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                        <div class="flex items-center gap-2 text-sm">
                            <span class="material-symbols-rounded text-primary">folder_open</span>
                            <span class="font-bold">{{ jmFavFolderTitle }}</span>
                            <span class="opacity-60">· Page {{ jmFavPage }} / {{ jmFavTotalPages }}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button @click="loadJmFavorites(jmFavPage - 1)" :disabled="jmFavPage <= 1 || jmFavLoading"
                                class="w-10 h-10 rounded-full bg-surface-variant text-on-surface-variant flex items-center justify-center disabled:opacity-30 hover:bg-primary hover:text-on-primary transition">
                                <span class="material-symbols-rounded">arrow_back</span>
                            </button>
                            <button @click="loadJmFavorites(jmFavPage + 1)" :disabled="jmFavPage >= jmFavTotalPages || jmFavLoading"
                                class="w-10 h-10 rounded-full bg-surface-variant text-on-surface-variant flex items-center justify-center disabled:opacity-30 hover:bg-primary hover:text-on-primary transition">
                                <span class="material-symbols-rounded">arrow_forward</span>
                            </button>
                        </div>
                    </div>

                    <div class="md-card p-4 border border-outline/10">
                        <div class="flex flex-col md:flex-row md:items-center gap-3">
                            <div class="flex-1 md-input-container flex items-center px-4 h-12">
                                <span class="material-symbols-rounded text-primary mr-3">manage_search</span>
                                <input v-model="jmFavTitleFilter" class="md-input w-full text-sm" placeholder="按标题筛选（本地）">
                            </div>
                            <div v-if="jmFavSelectionMode" class="flex items-center gap-2">
                                <button @click="toggleJmFavSelectAll" class="h-12 px-5 rounded-full bg-surface-variant border border-outline/10 text-on-surface-variant hover:bg-primary hover:text-on-primary transition text-sm font-bold">
                                    <span class="material-symbols-rounded text-base mr-1">select_all</span>
                                    全选
                                </button>
                                <button @click="openJmFavBatchMove" :disabled="jmFavSelectedCount === 0"
                                    class="md-btn-primary h-12 px-6 disabled:opacity-40 disabled:cursor-not-allowed">
                                    <span class="material-symbols-rounded text-base mr-1">drive_file_move</span>
                                    批量移动 {{ jmFavSelectedCount }}
                                </button>
                            </div>
                        </div>
                        <div v-if="jmFavSelectionMode" class="text-xs opacity-60 mt-3 flex items-center gap-2">
                            <span class="material-symbols-rounded text-primary text-base">info</span>
                            点击封面或标题可选择/取消选择
                        </div>
                    </div>

                    <loading-state :loading="jmFavLoading && jmFavItems.length === 0">
                        <span class="mt-2 text-sm text-on-surface-variant">正在加载收藏...</span>
                    </loading-state>

                    <div v-if="!jmFavLoading && jmFavItems.length === 0" class="md-card p-8 md:p-10 border border-outline/10 flex flex-col items-center justify-center opacity-70">
                        <span class="material-symbols-rounded text-6xl text-outline mb-3">favorite_border</span>
                        <div class="font-bold text-on-surface-variant">暂无收藏</div>
                        <button @click="currentTab='search'" class="mt-5 md-btn-primary">去搜索</button>
                    </div>

                    <div v-else-if="!jmFavLoading && jmFavFilteredItems.length === 0" class="md-card p-8 md:p-10 border border-outline/10 flex flex-col items-center justify-center opacity-70">
                        <span class="material-symbols-rounded text-6xl text-outline mb-3">search_off</span>
                        <div class="font-bold text-on-surface-variant">没有匹配的标题</div>
                        <button @click="jmFavTitleFilter=''" class="mt-5 h-10 px-6 rounded-full bg-surface-variant border border-outline/10 text-on-surface-variant hover:bg-primary hover:text-on-primary transition font-bold">清除筛选</button>
                    </div>

                    <div v-if="jmFavFilteredItems.length > 0" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6">
                        <div v-for="item in jmFavFilteredItems" :key="item.album_id"
                            class="md-card overflow-hidden group flex flex-col h-full bg-surface-container hover:bg-surface-container-high transition-all duration-300 hover:shadow-lg">
                            <div class="aspect-[3/4] overflow-hidden relative bg-surface-variant cursor-pointer"
                                    @click="jmFavSelectionMode ? toggleJmFavSelectOne(item.album_id) : viewDetails(item.album_id)">
                                <img v-if="item.image" :src="getImageUrl(item.image)" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" loading="lazy" alt="Cover">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                <div v-if="jmFavSelectionMode" class="absolute top-2 right-2 w-9 h-9 rounded-full border border-white/30 backdrop-blur bg-black/30 flex items-center justify-center transition-transform active:scale-95">
                                    <span class="material-symbols-rounded text-white">{{ isJmFavSelected(item.album_id) ? 'check_circle' : 'radio_button_unchecked' }}</span>
                                </div>
                            </div>
                            <div class="p-3 flex flex-col flex-1">
                                <div class="font-medium text-sm line-clamp-2 leading-tight mb-2 group-hover:text-primary transition-colors cursor-pointer"
                                        @click="jmFavSelectionMode ? toggleJmFavSelectOne(item.album_id) : viewDetails(item.album_id)">
                                    {{ item.title }}
                                </div>
                                <div class="text-xs opacity-70 truncate">{{ item.author }}</div>
                                <div v-if="!jmFavSelectionMode" class="mt-auto pt-3 flex items-center justify-between gap-2">
                                    <button @click="openJmMoveFavorite(item)" class="h-9 px-3 rounded-full bg-surface-variant border border-outline/10 text-on-surface-variant hover:bg-primary hover:text-on-primary transition text-xs font-bold">
                                        <span class="material-symbols-rounded text-base mr-1">drive_file_move</span>
                                        移动
                                    </button>
                                    <button @click="removeJmFavorite(item)" class="w-9 h-9 rounded-full bg-surface-variant border border-outline/10 text-on-surface-variant hover:bg-error hover:text-on-error transition flex items-center justify-center">
                                        <span class="material-symbols-rounded text-base">remove_circle</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <pagination-controls 
                        v-if="!jmFavLoading && jmFavFilteredItems.length > 0"
                        :page="jmFavPage" 
                        :loading="jmFavLoading" 
                        :has-more="jmFavPage < jmFavTotalPages"
                        @prev="loadJmFavorites(jmFavPage - 1)" 
                        @next="loadJmFavorites(jmFavPage + 1)">
                    </pagination-controls>
                </div>
            </div>

            <transition name="fade">
                <div v-if="jmFavShowCreate" class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div class="bg-surface md-card p-4 md:p-6 max-w-sm w-full shadow-2xl" @click.stop>
                        <div class="text-xl font-bold mb-2 flex items-center gap-2">
                            <span class="material-symbols-rounded text-primary">create_new_folder</span>
                            新建收藏夹
                        </div>
                        <div class="md-input-container mt-4">
                            <input v-model="jmFavNewFolderName" type="text" placeholder="Folder name" class="md-input w-full p-4 bg-transparent" @keyup.enter="createJmFolder">
                        </div>
                        <div v-if="jmFavCreateError" class="mt-3 p-3 rounded-2xl bg-error/10 border border-error/20 text-sm text-error break-words">
                            {{ jmFavCreateError }}
                        </div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button @click="closeJmFolderCreate" class="px-4 py-2 rounded-full text-primary hover:bg-primary/10 transition font-medium">Cancel</button>
                            <button @click="createJmFolder" :disabled="!jmFavNewFolderName.trim() || jmFavFolderOpLoading"
                                class="md-btn-primary h-10 px-5 disabled:opacity-40 disabled:cursor-not-allowed">
                                <span class="material-symbols-rounded" :class="jmFavFolderOpLoading ? 'animate-spin' : ''">{{ jmFavFolderOpLoading ? 'progress_activity' : 'check' }}</span>
                                Create
                            </button>
                        </div>
                    </div>
                </div>
            </transition>

            <transition name="fade">
                <div v-if="jmFavShowMove" class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div class="bg-surface md-card p-4 md:p-6 max-w-md w-full shadow-2xl" @click.stop>
                        <div class="flex items-start justify-between gap-3 mb-4">
                            <div class="min-w-0">
                                <div class="text-xl font-bold flex items-center gap-2">
                                    <span class="material-symbols-rounded text-primary">drive_file_move</span>
                                    移动到收藏夹
                                </div>
                                <div class="text-sm opacity-60 mt-1 truncate">{{ jmFavMoveTitle }}</div>
                            </div>
                            <button @click="closeJmMoveFavorite" class="w-10 h-10 rounded-full bg-surface-variant text-on-surface-variant hover:bg-surface transition flex items-center justify-center">
                                <span class="material-symbols-rounded">close</span>
                            </button>
                        </div>

                        <div class="flex flex-wrap gap-2">
                            <button v-for="f in jmFavFolders" :key="f.id"
                                @click="jmFavMoveFolderId = f.id"
                                class="h-10 px-4 rounded-full border text-sm font-medium transition"
                                :class="jmFavMoveFolderId === f.id ? 'bg-primary text-on-primary border-transparent shadow-md' : 'bg-surface text-on-surface border-outline/20 hover:bg-primary/10'">
                                {{ f.name }}
                            </button>
                        </div>

                        <div class="flex justify-end gap-3 mt-6">
                            <button @click="closeJmMoveFavorite" class="px-4 py-2 rounded-full text-primary hover:bg-primary/10 transition font-medium">Cancel</button>
                            <button @click="confirmJmMoveFavorite" :disabled="jmFavFolderOpLoading || !jmFavMoveFolderId"
                                class="md-btn-primary h-10 px-5 disabled:opacity-40 disabled:cursor-not-allowed">
                                <span class="material-symbols-rounded" :class="jmFavFolderOpLoading ? 'animate-spin' : ''">{{ jmFavFolderOpLoading ? 'progress_activity' : 'check' }}</span>
                                Move
                            </button>
                        </div>
                    </div>
                </div>
            </transition>

            <transition name="fade">
                <div v-if="jmFavShowBatchMove" class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div class="bg-surface md-card p-6 max-w-md w-full shadow-2xl" @click.stop>
                        <div class="flex items-start justify-between gap-3 mb-4">
                            <div class="min-w-0">
                                <div class="text-xl font-bold flex items-center gap-2">
                                    <span class="material-symbols-rounded text-primary">drive_file_move</span>
                                    批量移动
                                </div>
                                <div class="text-sm opacity-60 mt-1 truncate">已选择 {{ jmFavSelectedCount }} 项</div>
                            </div>
                            <button @click="closeJmFavBatchMove" class="w-10 h-10 rounded-full bg-surface-variant text-on-surface-variant hover:bg-surface transition flex items-center justify-center">
                                <span class="material-symbols-rounded">close</span>
                            </button>
                        </div>

                        <div class="flex flex-wrap gap-2">
                            <button v-for="f in jmFavFolders" :key="f.id"
                                @click="jmFavBatchFolderId = f.id"
                                class="h-10 px-4 rounded-full border text-sm font-medium transition"
                                :class="jmFavBatchFolderId === f.id ? 'bg-primary text-on-primary border-transparent shadow-md' : 'bg-surface text-on-surface border-outline/20 hover:bg-primary/10'">
                                {{ f.name }}
                            </button>
                        </div>

                        <div class="flex justify-end gap-3 mt-6">
                            <button @click="closeJmFavBatchMove" class="px-4 py-2 rounded-full text-primary hover:bg-primary/10 transition font-medium">Cancel</button>
                            <button @click="confirmJmFavBatchMove" :disabled="jmFavBatchMoving || !jmFavBatchFolderId || jmFavSelectedCount === 0"
                                class="md-btn-primary h-10 px-5 disabled:opacity-40 disabled:cursor-not-allowed">
                                <span class="material-symbols-rounded" :class="jmFavBatchMoving ? 'animate-spin' : ''">{{ jmFavBatchMoving ? 'progress_activity' : 'check' }}</span>
                                Move
                            </button>
                        </div>
                    </div>
                </div>
            </transition>

            <transition name="fade">
                <div v-if="jmFavShowRename" class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div class="bg-surface md-card p-6 max-w-sm w-full shadow-2xl" @click.stop>
                        <div class="text-xl font-bold mb-2 flex items-center gap-2">
                            <span class="material-symbols-rounded text-primary">edit</span>
                            重命名收藏夹
                        </div>
                        <div class="md-input-container mt-4">
                            <input v-model="jmFavRenameFolderName" type="text" placeholder="Folder name" class="md-input w-full p-4 bg-transparent" @keyup.enter="confirmJmFolderRename">
                        </div>
                        <div class="text-xs opacity-60 mt-3">如果上游不支持，会提示“暂不支持重命名”</div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button @click="closeJmFolderRename" class="px-4 py-2 rounded-full text-primary hover:bg-primary/10 transition font-medium">Cancel</button>
                            <button @click="confirmJmFolderRename" :disabled="!jmFavRenameFolderName.trim() || jmFavFolderOpLoading"
                                class="md-btn-primary h-10 px-5 disabled:opacity-40 disabled:cursor-not-allowed">
                                <span class="material-symbols-rounded" :class="jmFavFolderOpLoading ? 'animate-spin' : ''">{{ jmFavFolderOpLoading ? 'progress_activity' : 'check' }}</span>
                                Rename
                            </button>
                        </div>
                    </div>
                </div>
            </transition>
        </div>
    </transition>
