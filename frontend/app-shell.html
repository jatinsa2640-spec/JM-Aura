<!-- Navigation Rail (Desktop) / Bottom Bar (Mobile) -->
<nav class="md-nav-rail fixed bottom-0 left-0 w-full h-20 lg:w-24 lg:h-full lg:flex-col lg:border-r flex justify-around items-center z-50 shadow-[0_-2px_10px_rgba(0,0,0,0.05)] lg:shadow-none lg:py-8">
    <!-- Brand Icon (Desktop only) -->
    <div class="hidden lg:flex flex-col items-center justify-center mb-8 text-primary cursor-pointer" @click="toggleTheme">
         <span class="material-symbols-rounded text-4xl transform transition hover:rotate-180">menu_book</span>
    </div>

    <div class="flex lg:flex-col w-full justify-around lg:justify-start lg:gap-4 lg:px-4">
        <button @click="currentTab = 'home'"
            class="md-nav-item flex flex-col items-center justify-center w-16 h-12 lg:w-16 lg:h-16 rounded-full"
            :class="{ 'active': currentTab === 'home' }">
            <span class="material-symbols-rounded text-2xl lg:text-3xl">home</span>
            <span class="text-[10px] font-medium mt-0.5 sm:hidden">Home</span>
        </button>

        <button
            @pointerdown="onJmNavPressStart"
            @pointerup="onJmNavPressCancel"
            @pointercancel="onJmNavPressCancel"
            @pointerleave="onJmNavPressCancel"
            @click="onJmRandomNavClick"
            @contextmenu.prevent="showJmMenu = true; jmNavSuppressClickUntil = Date.now() + 900"
            class="md-nav-item flex flex-col items-center justify-center w-16 h-12 lg:w-16 lg:h-16 rounded-full"
            :class="{ 'active': currentTab === 'jm_random' }"
        >
            <span class="material-symbols-rounded text-2xl lg:text-3xl">casino</span>
            <span class="text-[10px] font-medium mt-0.5 sm:hidden">随机</span>
        </button>

        <button @click="currentTab = 'search'" 
            class="md-nav-item flex flex-col items-center justify-center w-16 h-12 lg:w-16 lg:h-16 rounded-full"
            :class="{ 'active': currentTab === 'search' || currentTab === 'detail' }">
            <span class="material-symbols-rounded text-2xl lg:text-3xl">search</span>
            <span class="text-[10px] font-medium mt-0.5 sm:hidden">Search</span>
        </button>

        <button @click="currentTab = 'jm_favorites'"
            class="md-nav-item flex flex-col items-center justify-center w-16 h-12 lg:w-16 lg:h-16 rounded-full"
            :class="{ 'active': currentTab === 'favorites' || currentTab === 'jm_favorites' }">
            <span class="material-symbols-rounded text-2xl lg:text-3xl">favorite</span>
            <span class="text-[10px] font-medium mt-0.5 sm:hidden">Favorites</span>
        </button>

        <button @click="currentTab = 'config'" 
            class="md-nav-item flex flex-col items-center justify-center w-16 h-12 lg:w-16 lg:h-16 rounded-full"
            :class="{ 'active': currentTab === 'config' }">
            <span class="material-symbols-rounded text-2xl lg:text-3xl">settings</span>
            <span class="text-[10px] font-medium mt-0.5 sm:hidden">Config</span>
        </button>
    </div>
</nav>

<!-- Main Content Area -->
<main class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl" v-cloak>
    
    <!-- Global Toast Message -->
    <transition name="slide-up">
        <div v-if="globalMsg" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[200] w-auto max-w-sm">
            <div :class="globalMsgType === 'error' ? 'bg-red-500 text-white' : 'bg-gray-800 text-white'" 
                 class="px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 backdrop-blur-md bg-opacity-90">
                <span class="material-symbols-rounded text-xl">{{ globalMsgType === 'error' ? 'error' : 'check_circle' }}</span>
                <span class="font-medium text-sm">{{ globalMsg }}</span>
            </div>
        </div>
    </transition>

    <!-- Confirmation Modal -->
    <transition name="fade">
        <div v-if="showConfirmModal" class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
            <div class="bg-surface md-card p-6 max-w-sm w-full shadow-2xl scale-100" @click.stop>
                <h3 class="text-xl font-bold mb-2 text-on-surface">{{ confirmTitle }}</h3>
                <p class="text-on-surface-variant mb-6">{{ confirmMessage }}</p>
                <div class="flex justify-end gap-3">
                    <button @click="handleConfirm(false)" class="px-4 py-2 rounded-full text-primary hover:bg-primary/10 transition font-medium">
                        Cancel
                    </button>
                    <button @click="handleConfirm(true)" class="px-6 py-2 rounded-full bg-primary text-on-primary hover:bg-primary/90 transition font-medium shadow-lg shadow-primary/20">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="showJmMenu" class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" @click="showJmMenu = false">
            <div class="bg-surface md-card p-4 md:p-6 max-w-sm w-full shadow-2xl" @click.stop>
                <div class="flex items-center justify-between gap-3 mb-4">
                    <div class="text-xl font-bold flex items-center gap-2">
                        <span class="material-symbols-rounded text-primary">apps</span>
                        JM
                    </div>
                    <button @click="showJmMenu = false" class="w-10 h-10 rounded-full bg-surface-variant text-on-surface-variant hover:bg-surface transition flex items-center justify-center">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button @click="currentTab = 'jm_latest'; showJmMenu = false" class="h-12 rounded-2xl bg-surface-variant/60 border border-outline/10 hover:bg-primary hover:text-on-primary transition font-medium flex items-center justify-center gap-2">
                        <span class="material-symbols-rounded">new_releases</span>
                        最新
                    </button>
                    <button @click="currentTab = 'jm_categories'; showJmMenu = false" class="h-12 rounded-2xl bg-surface-variant/60 border border-outline/10 hover:bg-primary hover:text-on-primary transition font-medium flex items-center justify-center gap-2">
                        <span class="material-symbols-rounded">category</span>
                        分类
                    </button>
                    <button @click="currentTab = 'jm_leaderboard'; showJmMenu = false" class="h-12 rounded-2xl bg-surface-variant/60 border border-outline/10 hover:bg-primary hover:text-on-primary transition font-medium flex items-center justify-center gap-2">
                        <span class="material-symbols-rounded">leaderboard</span>
                        排行
                    </button>
                    <button @click="currentTab = 'jm_random'; showJmMenu = false" class="h-12 rounded-2xl bg-surface-variant/60 border border-outline/10 hover:bg-primary hover:text-on-primary transition font-medium flex items-center justify-center gap-2">
                        <span class="material-symbols-rounded">casino</span>
                        随机
                    </button>
                    <button @click="currentTab = 'jm_history'; showJmMenu = false" class="h-12 rounded-2xl bg-surface-variant/60 border border-outline/10 hover:bg-primary hover:text-on-primary transition font-medium flex items-center justify-center gap-2 col-span-2">
                        <span class="material-symbols-rounded">history</span>
                        历史
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="showDownloadTaskModal" class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
            <div class="bg-surface md-card p-6 max-w-md w-full shadow-2xl scale-100" @click.stop>
                <div class="flex items-start justify-between gap-3 mb-4">
                    <div class="min-w-0">
                        <h3 class="text-xl font-bold text-on-surface truncate">下载/打包进度</h3>
                        <p class="text-sm text-on-surface-variant truncate">{{ downloadTaskInfo?.album_title || selectedAlbum?.title || '' }}</p>
                    </div>
                    <button @click="closeDownloadTaskModal" class="w-10 h-10 rounded-full bg-surface-variant text-on-surface-variant hover:bg-surface transition flex items-center justify-center">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>

                <div class="space-y-4">
                    <div class="rounded-2xl bg-surface-variant/60 border border-outline/10 p-4">
                        <div class="flex items-center justify-between text-sm mb-2">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-rounded text-primary">downloading</span>
                                <span class="font-semibold text-on-surface">{{ downloadTaskInfo?.stage || 'queued' }}</span>
                            </div>
                            <span class="text-on-surface-variant font-medium">{{ Math.round((downloadTaskInfo?.percent || 0) * 100) }}%</span>
                        </div>
                        <div class="h-3 rounded-full bg-surface overflow-hidden border border-outline/10">
                            <div class="h-full bg-primary transition-all duration-300" :style="{ width: Math.min(100, Math.max(0, (downloadTaskInfo?.percent || 0) * 100)) + '%' }"></div>
                        </div>
                        <div class="flex items-center justify-between text-xs text-on-surface-variant mt-3">
                            <span>{{ downloadTaskInfo?.message || '' }}</span>
                            <span v-if="downloadTaskInfo?.total_images">
                                {{ downloadTaskInfo?.downloaded_images || 0 }} / {{ downloadTaskInfo?.total_images }} 张
                            </span>
                        </div>
                    </div>

                    <div class="flex items-center justify-end gap-3">
                        <a v-if="downloadTaskInfo?.status === 'completed' && downloadTaskInfo?.download_url"
                           :href="downloadTaskInfo.download_url"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="md-btn-primary h-10 px-5">
                            <span class="material-symbols-rounded mr-2">download</span>
                            打开下载
                        </a>
                        <button v-else class="md-btn-primary h-10 px-5 opacity-60 cursor-not-allowed" disabled>
                            <span class="material-symbols-rounded mr-2 animate-spin">progress_activity</span>
                            处理中…
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <!-- Placeholders for Views -->
    <div id="view-config"></div>
    <div id="view-home"></div>
    <div id="view-jm-latest"></div>
    <div id="view-jm-categories"></div>
    <div id="view-jm-leaderboard"></div>
    <div id="view-jm-random"></div>
    <div id="view-jm-history"></div>
    <div id="view-jm-favorites"></div>
    <div id="view-favorites"></div>
    <div id="view-search"></div>
    <div id="view-detail"></div>

</main>

<!-- Reader Placeholder -->
<div id="view-reader"></div>
